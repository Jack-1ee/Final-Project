name: DSP Final Project Full Workflow

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-verify:
    runs-on: ubuntu-latest

    steps:
    # ------------------------------------------------------------------
    # 1. 環境準備與編譯
    # ------------------------------------------------------------------
    - uses: actions/checkout@v4

    - name: Compile Code
      run: |
        echo "Compiling encoder and decoder..."
        gcc -O3 encoder.c -o encoder -lm
        gcc -O3 decoder.c -o decoder -lm
        chmod +x encoder decoder

    # ------------------------------------------------------------------
    # 2. Method 0: 格式轉換檢查
    # ------------------------------------------------------------------
    - name: Run Method 0 (Format Conversion)
      run: |
        echo "--- Method 0 Encoder ---"
        # 輸入: 0 Kimberly.bmp R.txt G.txt B.txt dim.txt
        ./encoder 0 Kimberly.bmp R.txt G.txt B.txt dim.txt
        
        echo "--- Method 0 Decoder ---"
        # 輸入: 0 ResKimberly_M0.bmp R.txt G.txt B.txt dim.txt
        # (這裡輸出檔名設為 ResKimberly_M0.bmp 以便與 Method 1 區隔)
        ./decoder 0 ResKimberly_M0.bmp R.txt G.txt B.txt dim.txt
        
        echo "--- Verify Method 0 (Diff/Cmp) ---"
        # 檢查 Kimberly.bmp 與 重建的圖檔 是否一樣
        cmp Kimberly.bmp ResKimberly_M0.bmp
        echo "Method 0 Verification Passed: Images are identical."

    # ------------------------------------------------------------------
    # 3. Method 1: 基礎 JPEG 與 誤差補償
    # ------------------------------------------------------------------
    - name: Run Method 1 (Baseline JPEG & Error Residual)
      run: |
        echo "--- Method 1 Encoder ---"
        # 輸出 Qt_*.txt, dim.txt, qF_*.raw, eF_*.raw
        ./encoder 1 Kimberly.bmp Qt_Y.txt Qt_Cb.txt Qt_Cr.txt dim.txt qF_Y.raw qF_Cb.raw qF_Cr.raw eF_Y.raw eF_Cb.raw eF_Cr.raw
        
        echo "--- Method 1 Decoder (a) : QRes ---"
        # 輸入 qF_*.raw, 輸出 QResKimberly.bmp (有損壓縮圖)
        ./decoder 1 QResKimberly.bmp Kimberly.bmp Qt_Y.txt Qt_Cb.txt Qt_Cr.txt dim.txt qF_Y.raw qF_Cb.raw qF_Cr.raw
        
        echo "--- Method 1 Decoder (b) : Res (Lossless) ---"
        # 輸入 qF_*.raw + eF_*.raw, 輸出 ResKimberly_M1.bmp (理論上要無損)
        ./decoder 1 ResKimberly_M1.bmp Qt_Y.txt Qt_Cb.txt Qt_Cr.txt dim.txt qF_Y.raw qF_Cb.raw qF_Cr.raw eF_Y.raw eF_Cb.raw eF_Cr.raw
        
        echo "--- Verify Method 1(b) (Diff/Cmp) ---"
        # 檢查 Kimberly.bmp 與 Method 1(b) 重建圖 是否一樣
        cmp Kimberly.bmp ResKimberly_M1.bmp
        echo "Method 1(b) Verification Passed: Images are identical."

    # ------------------------------------------------------------------
    # 4. Method 2: 熵編碼 (Entropy Coding)
    # ------------------------------------------------------------------
    - name: Run Method 2 (Entropy Coding - ASCII & Binary)
      run: |
        # ==========================
        # Method 2(a) - ASCII Mode
        # ==========================
        echo "--- Method 2(a) Encoder (ASCII) ---"
        # 輸出 rle_code.txt
        ./encoder 2 Kimberly.bmp ascii rle_code.txt
        
        echo "--- Method 2(a) Decoder (ASCII) ---"
        # 輸出 QRes_M2_Ascii.bmp
        ./decoder 2 QRes_M2_Ascii.bmp ascii rle_code.txt
        
        echo "--- Verify Method 2(a) vs Method 1 QRes ---"
        # 檢查 Method 2 解出的圖 是否等於 Method 1 的 QResKimberly.bmp
        cmp QResKimberly.bmp QRes_M2_Ascii.bmp
        echo "Method 2(a) Verification Passed."

        # ==========================
        # Method 2(b) - Binary Mode
        # ==========================
        echo "--- Method 2(b) Encoder (Binary) ---"
        # 輸出 rle_code.bin
        ./encoder 2 Kimberly.bmp binary rle_code.bin
        
        echo "--- Method 2(b) Decoder (Binary) ---"
        # 輸出 QRes_M2_Bin.bmp
        ./decoder 2 QRes_M2_Bin.bmp binary rle_code.bin
        
        echo "--- Verify Method 2(b) vs Method 1 QRes ---"
        # 檢查 Method 2 解出的圖 是否等於 Method 1 的 QResKimberly.bmp
        cmp QResKimberly.bmp QRes_M2_Bin.bmp
        echo "Method 2(b) Verification Passed."

    # ------------------------------------------------------------------
    # 5. 上傳產出物 (Artifacts)
    # ------------------------------------------------------------------
    - name: Upload Artifacts
      if: always() # 即使上面測試失敗，也嘗試上傳 log 或已產生的檔案
      uses: actions/upload-artifact@v4
      with:
        name: Final-Project-Outputs
        path: |
          encoder
          decoder
          *.bmp
          *.txt
          *.bin
          *.raw